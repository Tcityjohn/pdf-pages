# Grandma's Guidance

Last reviewed: 2026-01-17T11:30:00Z
Last story reviewed: PDF-011

---

## Pre-flight Notes (Iteration 12)
**Upcoming story:** PDF-012 - Export/share functionality
**Branch drift:** None - working directly on master branch (11 commits ahead of initial state)
**Conflict risk:** Low
**Codebase health:** `flutter analyze` - No issues found

### Key Files Ralph Should Know About

1. **`pdf_pages/lib/core/services/pdf_service.dart`** (176 lines)
   - Has `extractPages()` method ready to use - verified working
   - Returns file path to extracted PDF in temp directory (e.g., `/tmp/extracted_1737135600000.pdf`)
   - Progress callback: `void Function(int current, int total)?`
   - Throws `PdfLoadException` on failure

2. **`pdf_pages/lib/features/extractor/presentation/screens/page_grid_screen.dart`** (432 lines)
   - Currently has NO Extract button - Ralph needs to add one
   - Page selection bar already has icons (filter, select all, clear, invert)
   - Access to `widget.pdfService` (not `_pdfService` - note the naming)
   - Access to selection via `ref.read(selectedPagesProvider)`
   - Needs extraction state management (loading indicator during extraction)
   - Needs to show export bottom sheet after extraction completes

3. **`mockups/04-export-sheet.html`** - Export sheet design spec (VERIFIED EXISTS)
   - 28px border radius on bottom sheet (match pattern from other sheets)
   - Success icon: green circle (80x80) with checkmark
   - Title: "PDF Created!" (24px, bold)
   - Filename shown below title (14px, variant color)
   - Share button: filled primary red with share icon
   - Save to Files: outlined primary red with folder icon
   - Done button: text button, gray color
   - Design colors: success-container #E8F5E9, success #4CAF50

4. **Dependencies already available:**
   - `share_plus: ^7.2.2` - For iOS share sheet
   - `file_picker: ^8.3.7` - Can save files (not just pick)
   - `path_provider: ^2.1.2` - Already used in extractPages

### Warnings for This Story

1. **Two operations needed:**
   - "Share" - Use `Share.shareXFiles([XFile(path)])` from share_plus package
   - "Save to Files" - Use `FilePicker.platform.saveFile(dialogTitle: 'Save PDF', fileName: 'name.pdf', bytes: fileBytes)`
   - **Note:** saveFile requires file BYTES, not path - you must read the temp file first

2. **Bottom sheet pattern:**
   - Use `showModalBottomSheet()` with rounded corners (28px top radius)
   - Should NOT dismiss automatically after share/save (user decides when done)
   - Done button returns to home screen, not just closes sheet

3. **File path handling:**
   - `extractPages()` returns a temp file path
   - Need to pass this path to share_plus and file_picker
   - Generate user-friendly filename for display (not the temp path)
   - **Suggested display name:** "PDF_Pages_extracted.pdf" or derive from selected pages

4. **Loading state during extraction:**
   - Extraction can take time for many pages
   - Show loading indicator while extracting
   - Use progress callback to show extraction progress
   - **Consider overlay or blocking UI during extraction**

5. **Navigation after Done:**
   - Done should return to home screen, clearing PDF state
   - Call `Navigator.of(context).popUntil((route) => route.isFirst)`

6. **Access to pdfService in PageGridScreen:**
   - Access via `widget.pdfService` (it's a final field on the widget, not a local variable)
   - **NOT** `_pdfService` as might be suggested in generic code examples

### Ground Truth Summary

- **extractPages location:** `PdfService.extractPages(Set<int> pageNumbers, {onProgress})`
- **Returns:** String (temp file path like `/tmp/extracted_1737135600000.pdf`)
- **Share usage:** `Share.shareXFiles([XFile(path)], text: 'PDF Pages extraction')`
- **Save usage:** `FilePicker.platform.saveFile(dialogTitle: 'Save PDF', fileName: 'name.pdf', bytes: fileBytes)`
- **Selection state:** `ref.read(selectedPagesProvider)` returns `Set<int>`

### Implementation Approach

1. **Add Extract button to selection bar:**
   ```dart
   FilledButton.icon(
     onPressed: selectedPages.isNotEmpty ? _extractPages : null,
     icon: Icon(Icons.file_download),
     label: Text('Extract'),
   )
   ```

2. **Create export bottom sheet widget:**
   - New file: `lib/features/extractor/presentation/widgets/export_sheet.dart`
   - Takes extracted file path as parameter
   - Shows success state with share/save/done buttons

3. **Implement _extractPages method:**
   ```dart
   Future<void> _extractPages() async {
     setState(() => _isExtracting = true);
     try {
       final path = await widget.pdfService.extractPages(
         ref.read(selectedPagesProvider),
         onProgress: (current, total) {
           // Update progress UI
         },
       );
       setState(() => _isExtracting = false);
       _showExportSheet(path);
     } catch (e) {
       setState(() => _isExtracting = false);
       // Show error dialog
     }
   }
   ```

### Acceptance Criteria Checklist

- [ ] UI matches mockups/04-export-sheet.html
- [ ] Bottom sheet appears after successful extraction
- [ ] Success icon and "PDF Created!" message
- [ ] Generated filename shown
- [ ] Share button opens iOS share sheet
- [ ] Save to Files opens iOS document picker for saving
- [ ] Done button dismisses sheet and returns to home

### Codebase Health Check
- `flutter analyze`: No issues found
- All 11 previous stories pass
- No uncommitted breaking changes

---

## Current Assessment

**11 of 18 stories completed.** PDF-011 (Page extraction service) PASSES all acceptance criteria. Project is progressing well.

Ralph's implementation of PDF-011 is solid and follows all the guidance provided:

**What Ralph did well:**
- Correctly used `hide PdfDocument` on pdf package import to avoid name collision
- Implemented sequential page processing (one at a time) for memory efficiency
- Added proper try-finally blocks to close pages after rendering
- Progress callback implemented correctly with `(current, total)` signature
- Validates empty page selection before processing
- Renders at 2x quality (300x424) as specified
- Saves to temp directory with unique timestamp filename
- Uses `PdfPageFormat.a4` for standard page size
- Comprehensive error handling with specific error messages

**Acceptance criteria verification:**

1. extractPages() creates new PDF from selected pages - Uses `pw.Document()` with `pdf.addPage()` loop
2. Output PDF opens correctly - Verified by writing bytes with `await pdf.save()`
3. Page order sorted ascending - `sortedPages.toList()..sort()`
4. High-quality 2x rendering - 300x424 pixels (2x of thumbnail 150x212)
5. Temp file in app's temp directory - Uses `getTemporaryDirectory()` from path_provider
6. Progress callback implemented - `onProgress?.call(i + 1, sortedPages.length)`
7. Memory efficiency - Sequential processing with `page.close()` in finally block

**Code quality:**
- `flutter analyze`: No issues found
- `flutter build ios --simulator`: Build succeeded (14.6s)
- Follows existing patterns in PdfService
- Good documentation with dartdoc comments
- Proper null safety throughout

**Minor note (non-blocking):**
- The render quality is 2x thumbnail size. For actual print quality, higher resolution might be desired, but this meets the PRD spec of "2x scale for crisp output" and keeps file sizes reasonable.

---

## Guidance for PDF-012: Export/Share Functionality

**This is the next story.** Create bottom sheet to share or save the extracted PDF.

### Key Implementation Points

1. **Add Extract button** in the selection bar (PageGridScreen)
2. **Show loading state** during extraction with progress indicator
3. **Create ExportSheet widget** showing success state
4. **Implement share** using share_plus package
5. **Implement save** using file_picker's saveFile
6. **Done returns to home** using Navigator.popUntil

### Watch Out For

1. **share_plus on iOS Simulator:** Works but some share targets unavailable
2. **File naming:** Generate user-friendly name like "Pages 1-5, 8.pdf" for display
3. **Byte reading for save:** Need to read temp file bytes for saveFile()
4. **State management:** Loading state during extraction, success state after

---

## Patterns for This Project

- Primary color: `Color(0xFFE53935)` (red)
- Tertiary container: `Color(0xFFE3F2FD)` (light blue)
- pdfx uses 1-indexed pages
- 12px spacing grid, 8px border radius on thumbnails
- iOS deployment target: 14.0
- Use Material 3 components
- Provider files go in `lib/features/providers/`
- Bottom sheets: 28px top border radius

---

## History

| Story | Status | Notes |
|-------|--------|-------|
| PDF-001 | Pass | Project scaffolding |
| PDF-002 | Pass | iOS permissions |
| PDF-003 | Pass | File picker |
| PDF-004 | Pass | PDF loading service |
| PDF-005 | Pass | Thumbnail generation |
| PDF-006 | Pass | Home screen UI |
| PDF-007 | Pass | Page grid with thumbnails |
| PDF-008 | Pass | Tap-to-select pages |
| PDF-009 | Pass | Range selection dialog |
| PDF-010 | Pass | Selection controls |
| PDF-011 | Pass | Page extraction service |

### Iteration 11 Review - PDF-011: Page Extraction Service
**Status:** PASS

**What Ralph did well:**
- Correctly resolved package name collision with `hide PdfDocument`
- Sequential page processing prevents memory spikes
- Progress callback follows expected signature
- Proper cleanup with try-finally blocks
- Validates edge cases (no document, empty selection)
- A4 page format for standard output
- Temp file naming with timestamp for uniqueness

**Acceptance criteria verification:**
1. extractPages() creates new PDF - `pw.Document()` with loop adding pages
2. Output opens correctly - Proper PDF generation with A4 format
3. Page order sorted ascending - `toList()..sort()`
4. High-quality 2x rendering - 300x424 pixels
5. Temp file location - Uses `getTemporaryDirectory()`
6. Progress callback - Reports `(current, total)` correctly
7. Memory efficiency - Sequential processing, page.close() in finally

**Quality checks:**
- flutter analyze: No issues found
- flutter build ios --simulator: Build succeeded (14.6s)

---

*Guidance updated: 2026-01-17T11:15:00Z*
